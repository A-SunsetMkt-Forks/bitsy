<!DOCTYPE HTML>
<html>

<head>

<!-- stop weird zooming out -->
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- UTIL SCRIPTS -->
<script src="shared/script/color_util.js"></script>

<!-- ENGINE SCRIPTS -->
<script src="shared/script/font.js"></script>
<script src="shared/script/script.js"></script>
<script src="shared/script/dialog.js"></script>
<script src="shared/script/parser.js"></script>
<script src="shared/script/renderer.js"></script>
<script src="shared/script/bitsy.js"></script>

<script src="shared/script/editor/core.js"></script>

<style>
body {
	margin: 0;
	padding: 0;
	width: 100%;
	height: 100%;
}

.editableContainer {
	background: yellow;
	border-bottom: solid 2px black;
}

.editableCanvas {
	width: 100%;
	/*max-width: 512px;*/
}

#game {
	width:100%;
	margin-top: calc(50vh - 5vh - 50%);
	background: black;
}

#gameHolder {
	padding-top: 10vh;
}
</style>

<script>
/*
TODO
	- assumption that room has to be drawn on a particular canvas (hack fix)
	-X sprite rendering
	- modes??
	- X events
	- Qs
		- what palette should sprites use?
	- longterm thoughts for game data
		- new id generation system (hex starting with 0)
		- dialog attached to sprites
		- endings attached to rooms
		- fixed width tile ids
		- sprite & item layers in room map
	- todo for first testable version
		X export game data
		- edit rooms
			- how do you select the current tile?
		X add drawings (sprite / tile)
		- edit dialog
		X play game
		- remove drawings?
		- edit title?
		- change color palette?
		- modes?
	- toolbar command state manager thingy
	- improve game data management
	- improve state changes between: document, data, play
	- idea: Wrapper for UI elements that makes it easier to append shit to them
	- views: document, play mode, data, tile picker
	- control bar manager
	X dialog!
		- what about multiline dialog???
		- what about "inline" dialog
	- usability
		- scroll to new tiles
		- only select drawings when NOT scrolling
		- stop scrolling while editing drawings
		- need way to deselect drawings
		- try shrinking drawings when not selected?
*/

	var InputType = {
		Mouse : 0,
		Touch : 1
	};
	var curInputType = InputType.Mouse;

	var gameDataManager;
	var events;

	function init() {
		events = new EventManager();

		var gameData = document.getElementById("exportedGameData").text.slice(1);
		parseWorld(gameData);

		gameDataManager = new GameDataManager(gameData);
		// generateDocument();

		isPlayerEmbeddedInEditor = true; // HACK!!!!
		textDirection = "LTR"; //hack

		// hack
		fontManager = new FontManager(true /*useExternalResources*/);
		fontManager.LoadResources([
			"ascii_small.bitsyfont",
			// "unicode_european_small.bitsyfont",
			// "unicode_european_large.bitsyfont",
			// "arabic_pixel.bitsyfont",
			// "unicode_asian.bitsyfont"
		], function() {
			console.log("ALL FONTS LOADED"); // TODO : happens multiple times because of hacky implementation :(
		});

		// detect mouse or touch
		window.addEventListener("mousedown", function(e) {
			if (curInputType != InputType.Mouse) {
				curInputType = InputType.Mouse;
				events.Raise("change_input_type", { type: curInputType });
			}
		});

		window.addEventListener("touchstart", function(e) {
			if (curInputType != InputType.Touch) {
				curInputType = InputType.Touch;
				events.Raise("change_input_type", { type: curInputType });
			}
		});
	}

	function generateDocument() { // TODO -- take in string input?
		var gameHolder = document.getElementById("gameHolder");
		gameHolder.innerHTML = "";

		var titleObj = new TitleCell();
		gameHolder.appendChild(titleObj.GetRootElement());

		for (var p in palette) {
			var obj = new PaletteCell(palette[p]);
			gameHolder.appendChild(obj.GetRootElement());
		}

		for (var r in room) {
			var obj = new RoomCell(room[r]);
			gameHolder.appendChild(obj.GetRootElement());
		}

		for (var s in sprite) {
			var obj;
			if (s === "A") {
				obj = new AvatarCell(sprite[s]);
			}
			else {
				obj = new SpriteCell(sprite[s]);
			}
			gameHolder.appendChild(obj.GetRootElement());
		}

		for (var t in tile) {
			var obj = new TileCell(tile[t]);
			gameHolder.appendChild(obj.GetRootElement());
		}
	}

	// TODO : this is awesome... port to original editor
	function EventManager() {
		var callbacks = {};

		this.Listen = function(eventName, callback) {
			if (callbacks[eventName] == null) {
				callbacks[eventName] = [];
			}

			callbacks[eventName].push(callback);
		}

		// this.Remove // TODO (use indexOf)

		this.Raise = function(eventName, eventObj) {
			if (callbacks[eventName] == null)
				return;

			for (var i = 0; i < callbacks[eventName].length; i++) {
				callbacks[eventName][i](eventObj);
			}
		}
	}

	// this object feels hacky to me!!!
	function GameDataManager(data) {
		var gameDataTextArea = document.getElementById("gameData");
		gameDataTextArea.value = data;

		generateDocument();

		function updateGameData() {
			data = serializeWorld(true);
			gameDataTextArea.value = data;
		}

		events.Listen("edit_sprite", updateGameData);
		events.Listen("edit_tile", updateGameData);
		events.Listen("add_sprite", updateGameData);
		events.Listen("add_tile", updateGameData);
		events.Listen("edit_title", updateGameData);
		events.Listen("edit_palette", updateGameData);
		events.Listen("edit_dialog", updateGameData);

		this.GetData = function() {
			return data;
		}
	}

	function EditableCell(name) {
		var rootElement = document.createElement("div");
		rootElement.className = "editableContainer";

		var nameElement = document.createElement("div");
		nameElement.innerText = name;
		rootElement.appendChild(nameElement);

		this.GetRootElement = function() {
			return rootElement;
		}
	}

	function RoomCell(room) {
		Object.assign( this, new EditableCell("ROOM " + room.id) );

		var rootElement = this.GetRootElement();

		var roomCanvas = document.createElement("canvas");
		roomCanvas.width = 512;
		roomCanvas.height = 512;
		roomCanvas.className = "editableCanvas";
		rootElement.appendChild(roomCanvas);

		var context = roomCanvas.getContext("2d");

		function redraw() {
			// hack (assumed singular canvas)
			canvas = roomCanvas;
			renderer.AttachContext(context);

			// extra SUPER HACK
			curRoom = room.id;

			drawRoom(room,context,0);
		}
		redraw();

		events.Listen("edit_sprite", function() {
			redraw();
		});

		events.Listen("edit_tile", function() {
			redraw();
		});

		events.Listen("edit_palette", function() {
			renderer.SetPalettes(palette); // TODO : less hacky way to clear renderer
			redraw(); // todo: respond to id
		});
	}

	function DrawingCell(name, drawing, colorIndex, editEvent) { // TODO rename "Objects" to something more descriptive: Editors? Editables? EditViews?
		Object.assign( this, new EditableCell(name) );

		var isCanvasSelected = false;

		var rootElement = this.GetRootElement();

		var paint_scale = 32;

		var paintCanvas = document.createElement("canvas");
		paintCanvas.width = paint_scale * tilesize;
		paintCanvas.height = paint_scale * tilesize;
		paintCanvas.className = "editableCanvas";
		rootElement.appendChild(paintCanvas);

		var context = paintCanvas.getContext("2d"); // TODO : rename to context

		// hacky over-specialization?
		function renderDrawing(ctx,drw,color,drawPaintGrid) {
			//background
			ctx.fillStyle = "rgb("+getPal(curPal())[0][0]+","+getPal(curPal())[0][1]+","+getPal(curPal())[0][2]+")";
			ctx.fillRect(0,0,canvas.width,canvas.height); // TODO : replace global "canvas"

			//pixel color
			ctx.fillStyle = "rgb("+color[0]+","+color[1]+","+color[2]+")";

			//draw pixels
			for (var x = 0; x < 8; x++) {
				for (var y = 0; y < 8; y++) {
					// draw first frame
					if (renderer.GetImageSource(drw)[0][y][x] === 1) {
						ctx.fillRect(x*paint_scale,y*paint_scale,1*paint_scale,1*paint_scale);
					}
				}
			}

			//draw grid
			if (drawPaintGrid) {
				ctx.fillStyle = curInputType == InputType.Mouse ? "red" : "green"; // getContrastingColor();
				console.log(ctx.fillStyle);

				for (var x = 1; x < tilesize; x++) {
					ctx.fillRect(x*paint_scale,0*paint_scale,1,tilesize*paint_scale);
				}
				for (var y = 1; y < tilesize; y++) {
					ctx.fillRect(0*paint_scale,y*paint_scale,tilesize*paint_scale,1);
				}
			}
		}

		function editDrawing(e, drw, drawingState) {
			var off = getOffset(e);
			off = mobileOffsetCorrection(off,e,(tilesize));

			var x = Math.floor(off.x);
			var y = Math.floor(off.y);

			var drawingData = renderer.GetImageSource(drw);
			drawingData[0][y][x] = drawingState;

			renderer.SetImageSource(drw, drawingData);
		}

		function startEditDrawing(e, drw) {
			var off = getOffset(e);
			off = mobileOffsetCorrection(off,e,(tilesize));

			var x = Math.floor(off.x);
			var y = Math.floor(off.y);

			var drawingData = renderer.GetImageSource(drw);
			var drawingState = drawingData[0][y][x] == 1 ? 0 : 1;

			editDrawing(e, drw, drawingState);

			return drawingState;
		}

		var curDrawingState = -1;

		function onmousedown(e) {
			if (isCanvasSelected) {
				curDrawingState = startEditDrawing(e, drawing.drw);

				renderDrawing(context,drawing.drw,getPal(curPal())[colorIndex],isCanvasSelected);

				events.Raise(editEvent); // TODO : specify WHICH drawing
			}
			else
			{
				events.Raise("select_canvas", { id: drawing.drw } );
			}
		}

		function onmousemove(e) {
			if (curDrawingState > -1) {
				editDrawing(e, drawing.drw, curDrawingState);

				renderDrawing(context,drawing.drw,getPal(curPal())[colorIndex],isCanvasSelected);

				events.Raise(editEvent); // TODO : specify WHICH drawing
			}
		}

		function onmouseup(e) {
			curDrawingState = -1;
		}

		function ontouchstart(e) {
			console.log("TOUCH START");
			// console.log(e);
			var fakeEvent = { target:e.target, clientX:e.touches[0].clientX, clientY:e.touches[0].clientY };
			onmousedown(fakeEvent);
		}

		function ontouchmove(e) {
			var fakeEvent = { target:e.target, clientX:e.touches[0].clientX, clientY:e.touches[0].clientY };
			onmousemove(fakeEvent);
		}

		function ontouchend(e) {
			// var fakeEvent = { target:e.target, clientX:e.touches[0].clientX, clientY:e.touches[0].clientY };
			onmouseup({});
		}

		function initInput(inputType) {
			paintCanvas.removeEventListener("mousedown", onmousedown);
			paintCanvas.removeEventListener("mousemove", onmousemove);
			paintCanvas.removeEventListener("mouseup", onmouseup);
			paintCanvas.removeEventListener("touchstart", ontouchstart);
			paintCanvas.removeEventListener("touchmove", ontouchmove);
			paintCanvas.removeEventListener("touchend", ontouchend);

			if (inputType == InputType.Mouse) {
				paintCanvas.addEventListener("mousedown", onmousedown);
				paintCanvas.addEventListener("mousemove", onmousemove);
				paintCanvas.addEventListener("mouseup", onmouseup);
			}
			else if (inputType == InputType.Touch) {
				paintCanvas.addEventListener("touchstart", ontouchstart);
				paintCanvas.addEventListener("touchmove", ontouchmove);
				paintCanvas.addEventListener("touchend", ontouchend);
			}
		}
		initInput(curInputType);

		events.Listen("change_input_type", function(e) {
			initInput(e.type);
		});

		events.Listen("select_canvas", function(e) {
			var selected = (e.id === drawing.drw);
			var didChange = isCanvasSelected != selected;
			isCanvasSelected = selected;
			renderDrawing(context,drawing.drw,getPal(curPal())[colorIndex],isCanvasSelected);
		});

		events.Listen("edit_palette", function(e) {
			// todo : check ID
			renderDrawing(context,drawing.drw,getPal(curPal())[colorIndex],isCanvasSelected);
		})

		renderDrawing(context,drawing.drw,getPal(curPal())[colorIndex],isCanvasSelected);
	}

	function AvatarCell(sprite) {
		Object.assign( this, new DrawingCell("AVATAR", sprite, 2, "edit_sprite") );
	}

	function SpriteCell(sprite) {
		Object.assign( this, new DrawingCell("SPRITE " + sprite.id, sprite, 2, "edit_sprite"));

		var rootElement = this.GetRootElement();

		var dialogDiv = document.createElement("div");
		rootElement.appendChild(dialogDiv);

		var dialogLabel = document.createElement("div");
		dialogLabel.innerText = "Dialog:";
		dialogDiv.appendChild(dialogLabel);

		var dialogTextarea = document.createElement("textarea");
		dialogTextarea.type = "textbox";
		if (sprite.dlg != null) {
			dialogTextarea.value = dialog[sprite.dlg];
		}
		dialogTextarea.addEventListener("change", function() {
			var dialogStr = dialogTextarea.value;

			if (dialogStr.length <= 0) {
				if (sprite.dlg != null) {
					delete dialog[sprite.dlg];
					sprite.dlg = null;
				}
			}
			else {
				if (sprite.dlg == null) {
					sprite.dlg = nextAvailableDialogId("SPR_"); // hacky!!!
				}
				dialog[sprite.dlg] = dialogStr;
			}

			events.Raise("edit_dialog"); // TODO identify target
		});
		dialogDiv.appendChild(dialogTextarea);
	}

	function TileCell(tile) {
		Object.assign( this, new DrawingCell("TILE " + tile.id, tile, 1, "edit_tile"));

		// console.log(tile);

		var rootElement = this.GetRootElement();

		var wallDiv = document.createElement("div");
		rootElement.appendChild(wallDiv);

		var wallLabel = document.createElement("span");
		wallLabel.innerText = "Wall: ";
		wallDiv.appendChild(wallLabel);

		var wallCheckbox = document.createElement("input");
		wallCheckbox.type = "checkbox";
		wallCheckbox.checked = tile.isWall == true;
		wallCheckbox.addEventListener("click", function(e) {
			// console.log("CHECK!!! " + wallCheckbox.checked);
			tile.isWall = wallCheckbox.checked;
			events.Raise("edit_tile"); // TODO : this forces a re-draw which seems bad
		});
		wallDiv.appendChild(wallCheckbox);
	}

	function TitleCell() {
		Object.assign( this, new EditableCell("Title") );

		var rootElement = this.GetRootElement();

		var titleDiv = document.createElement("div");
		rootElement.appendChild(titleDiv);

		var titleTextbox = document.createElement("input");
		titleTextbox.type = "textbox";
		titleTextbox.value = title; // HACK global (but unavoidalbe in this case)
		titleTextbox.addEventListener("change", function(e) {
			title = titleTextbox.value;
			events.Raise("edit_title");
		});
		titleDiv.appendChild(titleTextbox);
	}

	function PaletteCell(palette) {
		Object.assign( this, new EditableCell("PALETTE " + palette.id) );
		console.log(palette);

		var rootElement = this.GetRootElement();

		var colorDiv1 = document.createElement("div");
		rootElement.appendChild(colorDiv1);

		var colorTextbox1 = document.createElement("input");
		colorTextbox1.type = "textbox";
		colorTextbox1.value = rgbToHex(palette.colors[0][0], palette.colors[0][1], palette.colors[0][2]);
		colorTextbox1.style.border = "solid 2px " + colorTextbox1.value;
		colorTextbox1.addEventListener("change", function(e) {
			var rgb = hexToRgb(colorTextbox1.value);
			palette.colors[0] = [rgb.r, rgb.g, rgb.b];
			colorTextbox1.style.border = "solid 2px " + colorTextbox1.value;
			events.Raise("edit_palette", { id: palette.id });
		});
		colorDiv1.appendChild(colorTextbox1);

		var colorDiv2 = document.createElement("div");
		rootElement.appendChild(colorDiv2);

		var colorTextbox2 = document.createElement("input");
		colorTextbox2.type = "textbox";
		colorTextbox2.value = rgbToHex(palette.colors[1][0], palette.colors[1][1], palette.colors[1][2]);
		colorTextbox2.style.border = "solid 2px " + colorTextbox2.value;
		colorTextbox2.addEventListener("change", function(e) {
			var rgb = hexToRgb(colorTextbox2.value);
			palette.colors[1] = [rgb.r, rgb.g, rgb.b];
			colorTextbox2.style.border = "solid 2px " + colorTextbox2.value;
			events.Raise("edit_palette", { id: palette.id });
		});
		colorDiv2.appendChild(colorTextbox2);

		// TOO much copy paste :(
		var colorDiv3 = document.createElement("div");
		rootElement.appendChild(colorDiv3);

		var colorTextbox3 = document.createElement("input");
		colorTextbox3.type = "textbox";
		colorTextbox3.value = rgbToHex(palette.colors[2][0], palette.colors[2][1], palette.colors[2][2]);
		colorTextbox3.style.border = "solid 2px " + colorTextbox3.value;
		colorTextbox3.addEventListener("change", function(e) {
			var rgb = hexToRgb(colorTextbox3.value);
			palette.colors[2] = [rgb.r, rgb.g, rgb.b];
			colorTextbox3.style.border = "solid 2px " + colorTextbox3.value;
			events.Raise("edit_palette", { id: palette.id });
		});
		colorDiv3.appendChild(colorTextbox3);
	}

	function addSprite() {
		makeSprite(nextSpriteId());
		generateDocument(); // will this work without saving the game data & re-building it?
		events.Raise("add_sprite");
	}

	function addTile() {
		makeTile(nextTileId());
		generateDocument(); // will this work without saving the game data & re-building it?
		events.Raise("add_tile");
	}

	// !!!! TODO - turn these "toggles" into raised events handled by objects / managers
	function toggleGameData() {
		var gameData = document.getElementById("gameData");
		var gameHolder = document.getElementById("gameHolder");
		var playHolder = document.getElementById("playHolder");

		if (gameData.style.display == "none") {
			gameData.style.display = "block";
			gameHolder.style.display = "none";
			playHolder.style.display = "none";
		}
		else {
			gameData.style.display = "none";
			gameHolder.style.display = "block";
			playHolder.style.display = "none";
		}
	}

	function togglePlay() {
		var gameData = document.getElementById("gameData");
		var gameHolder = document.getElementById("gameHolder");
		var playHolder = document.getElementById("playHolder");

		if (playHolder.style.display == "none") {
			gameData.style.display = "none";
			gameHolder.style.display = "none";
			playHolder.style.display = "block";

			attachCanvas(document.getElementById("game"));
			load_game(serializeWorld());
		}
		else {
			gameData.style.display = "none";
			gameHolder.style.display = "block";
			playHolder.style.display = "none";

			stopGame();
			parseWorld(gameDataManager.GetData());
			generateDocument(); // feels hacky -- replace with data manager thingy?
		}
	}
</script>

</head>

<body onload="init();">
	<div id="gameHolder"></div><!-- TODO : RENAME -->
	<div id="playHolder" style="width:100vw; height:90vh; margin-top: 10vh; background:blue; display:none;">
		<canvas id="game"></canvas>
	</div>
	<textarea id="gameData" style="width:100vw; height:90vh; margin:0; margin-top: 10vh; border:none; display:none; resize:none;"></textarea>
	<div style="position:fixed; top:0vh; left:0; width:100vw; height:10vh; background:black; color:white;">
		toolbar
		<br/>
		<button onclick="togglePlay();">Play/Stop</button>
		<button onclick="addSprite();">+ Sprite</button>
		<button onclick="addTile();">+ Tile</button>
		<button onclick="toggleGameData();">Data</button>
	</div>

<script type="bitsyGameData" id="defaultGameData">
Write your game's title here

# BITSY VERSION 5.2

! ROOM_FORMAT 1

PAL 0
0,82,204
128,159,255
255,255,255

ROOM 0
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
0,a,a,a,a,a,a,a,a,a,a,a,a,a,a,0
0,a,0,0,0,0,0,0,0,0,0,0,0,0,a,0
0,a,0,0,0,0,0,0,0,0,0,0,0,0,a,0
0,a,0,0,0,0,0,0,0,0,0,0,0,0,a,0
0,a,0,0,0,0,0,0,0,0,0,0,0,0,a,0
0,a,0,0,0,0,0,0,0,0,0,0,0,0,a,0
0,a,0,0,0,0,0,0,0,0,0,0,0,0,a,0
0,a,0,0,0,0,0,0,0,0,0,0,0,0,a,0
0,a,0,0,0,0,0,0,0,0,0,0,0,0,a,0
0,a,0,0,0,0,0,0,0,0,0,0,0,0,a,0
0,a,0,0,0,0,0,0,0,0,0,0,0,0,a,0
0,a,0,0,0,0,0,0,0,0,0,0,0,0,a,0
0,a,0,0,0,0,0,0,0,0,0,0,0,0,a,0
0,a,a,a,a,a,a,a,a,a,a,a,a,a,a,0
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
PAL 0

TIL a
11111111
10000001
10000001
10011001
10011001
10000001
10000001
11111111

SPR A
00011000
00011000
00011000
00111100
01111110
10111101
00100100
00100100
POS 0 4,4

SPR a
00000000
00000000
01010001
01110001
01110010
01111100
00111100
00100100
DLG SPR_0
POS 0 8,12

ITM 0
00000000
00000000
00000000
00111100
01100100
00100100
00011000
00000000
NAME tea
DLG ITM_0

DLG SPR_0
I'm a cat

DLG ITM_0
You found a nice warm cup of tea

VAR a
42
</script>

<script type="bitsyGameData" id="exportedGameData">
Out of the rain

# BITSY VERSION 5.3

! ROOM_FORMAT 1

PAL 0
64,64,109
198,223,255
255,232,95

PAL 1
28,31,46
254,178,234
255,232,95

ROOM 0
a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a
a,a,a,a,a,a,a,a,a,a,a,a,d,d,a,a
a,a,a,a,a,a,a,a,a,a,a,d,d,d,d,a
a,a,a,a,a,a,a,a,a,a,a,d,c,d,d,a
0,0,0,0,0,u,0,0,0,0,0,c,0,c,d,0
0,0,p,0,0,q,0,0,b,0,0,0,u,0,c,0
0,0,n,n,n,n,0,0,0,0,0,u,0,s,0,s
0,0,n,n,n,n,0,0,0,0,s,0,0,0,0,0
0,0,g,g,v,g,0,0,0,0,0,0,0,n,n,n
0,0,v,v,w,v,0,0,p,0,0,q,0,n,n,n
0,0,0,0,x,0,0,0,n,n,n,n,0,g,g,g
0,0,0,0,0,0,0,o,r,r,r,n,e,f,f,f
0,e,e,e,l,m,l,o,n,n,o,n,e,e,l,e
0,0,e,e,e,k,k,k,g,g,o,v,e,m,k,k
0,0,0,0,e,e,e,e,f,f,o,f,e,m,l,e
0,0,0,0,0,0,e,e,e,e,k,k,k,k,e,e
PAL 0

ROOM 1
a,a,a,a,a,a,a,a,z,a,a,a,a,a,a,a
a,a,a,a,a,p,a,a,q,a,a,a,a,a,a,a
a,d,a,d,a,n,n,n,n,a,a,a,a,a,d,a
d,d,a,d,d,n,n,n,n,a,d,a,d,d,d,d
d,d,d,d,d,g,v,g,g,d,d,d,d,d,d,d
c,d,d,c,c,v,w,v,v,c,d,d,c,d,c,d
d,c,c,0,0,0,x,0,0,b,c,d,0,c,u,d
d,u,0,0,0,b,0,0,0,0,0,c,b,0,0,c
d,0,0,b,0,0,s,s,s,0,s,0,0,0,s,s
c,0,0,0,u,0,s,s,0,0,0,s,s,0,u,d
e,e,u,0,0,0,0,0,0,b,0,0,0,0,0,d
e,e,e,0,0,0,0,s,0,0,0,u,0,0,d,d
l,e,l,e,e,0,0,s,0,u,u,0,0,0,d,c
k,k,k,k,k,0,s,0,0,0,0,0,b,d,d,0
l,e,l,e,e,e,0,0,b,0,u,d,0,d,c,d
e,e,e,e,e,e,u,0,0,u,u,d,d,d,0,0
EXT 6,5 2 6,11
PAL 1

ROOM 2
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
0,0,0,0,0,0,0,0,0,z,0,0,0,0,0,0
0,0,0,0,0,p,0,0,0,q,0,0,0,0,0,0
0,0,0,0,n,n,n,n,n,n,n,n,0,0,0,0
0,0,0,0,v,v,v,v,v,0,v,v,0,0,0,0
0,0,0,0,v,0,0,0,0,0,0,v,0,0,0,0
0,0,0,0,v,0,10,0,0,0,0,v,0,0,0,0
0,0,0,0,v,0,0,0,10,0,0,v,0,0,0,0
0,0,0,0,v,0,0,0,0,0,y,v,0,0,0,0
0,0,0,0,v,0,10,0,0,10,0,v,0,0,0,0
0,0,0,0,v,0,0,0,0,0,0,v,0,0,0,0
0,0,0,0,v,v,0,v,v,v,v,v,0,0,0,0
0,0,0,0,0,0,x,0,0,0,0,0,0,0,0,0
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
ITM 0 8,5
EXT 6,12 1 6,6
PAL 1

ROOM 3
a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a
d,a,a,a,d,d,a,a,a,a,a,a,a,a,a,d
d,a,d,d,d,d,d,a,d,a,d,a,a,d,a,d
d,d,d,d,d,d,d,d,d,d,d,d,d,d,d,d
d,d,c,c,d,c,d,d,d,d,c,d,d,d,d,c
c,c,u,0,c,u,d,c,d,c,0,d,c,c,d,d
s,s,0,b,0,0,c,0,c,u,0,c,0,b,c,d
d,u,s,0,0,u,u,0,0,0,b,0,u,0,0,c
d,0,0,s,0,0,0,b,0,u,0,0,0,n,n,n
d,0,e,m,e,e,0,0,q,0,0,p,0,n,n,n
c,e,l,m,l,e,e,e,n,n,n,n,0,g,g,g
e,e,e,m,e,e,e,o,r,r,r,n,e,f,f,f
e,e,e,m,e,l,e,o,n,n,o,n,e,e,l,e
n,n,e,k,k,k,k,k,g,g,o,v,e,m,k,k
n,n,e,e,e,l,e,e,f,f,o,f,e,m,l,e
f,f,e,e,e,e,e,e,e,e,k,k,k,k,e,e
EXT 15,13 1 0,13
EXT 0,6 4 15,6
PAL 1

ROOM 4
a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a
a,a,a,a,d,a,a,d,a,a,a,a,d,a,a,a
d,a,d,d,d,d,a,d,a,d,a,d,d,a,a,d
d,d,d,d,d,d,d,d,d,d,d,d,d,d,d,d
d,d,c,c,c,d,c,c,c,d,d,c,d,d,d,d
d,c,0,s,s,c,s,s,0,c,d,u,c,d,c,c
c,s,0,b,u,d,d,0,d,d,d,b,0,c,0,s
d,0,s,0,0,d,d,d,d,c,c,0,0,0,s,d
d,b,0,s,0,c,c,d,c,u,0,s,s,b,0,d
d,0,0,s,0,e,e,c,d,0,s,0,0,0,u,c
c,e,e,m,e,e,e,e,d,e,m,e,e,e,e,u
e,e,l,m,l,e,e,e,d,0,0,b,e,e,e,e
e,e,e,k,k,k,0,0,c,b,0,t,e,e,e,e
e,e,e,e,e,e,t,t,t,t,t,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e
EXT 15,6 3 0,6
PAL 1

TIL 10
00000000
00000000
01110100
00000000
11011110
00000000
00111000
00000000

TIL a
00000000
01000000
01000010
00000010
00000000
10010000
10010000
10000000
>
00010000
00010100
00000100
01000100
01000000
00000000
00000010
00000010

TIL b
00000000
00000000
00000000
00110000
00000000
00000000
00000000
00000000
>
00000000
00000000
00110000
01001000
00110000
00000000
00000000
00000000

TIL c
01011000
00011000
00011000
00011010
00000000
00000000
00000000
00000000
>
00011010
00011000
01011000
00011000
00000000
00000000
00000000
00000000

TIL d
00011000
00011000
00111100
00111100
00111100
01111110
01111110
01111110

TIL e
10011001
01100110
00000000
00000000
11001100
00110011
00000000
00000000
>
00000000
11001100
00110011
00000000
00000000
10011001
01100110
00000000

TIL f
11111111
11111111
11111111
11111111
11111111
10011001
00000000
00000000
>
11111111
11111111
11111111
11111111
11111111
11111111
00110011
00000000

TIL g
11111111
11111111
11111111
11100111
11100111
11111111
11111111
11111111

TIL k
00000000
10101010
10101010
10101010
10101010
10101010
10101010
00000000

TIL l
00011000
00100100
00111100
00100100
00100100
01000010
00111100
00000000
>
00011000
00100100
00111100
00100100
01000010
00111100
00000000
00000000

TIL m
00000000
01111110
00000000
01111110
00000000
01111110
00000000
01111110

TIL n
01110111
01110111
00110011
00000000
11101110
11101110
01100110
00000000

TIL o
01000010
01111110
01000010
01111110
01000010
01111110
01000010
01111110

TIL p
00000000
00000000
01010100
11111110
01010100
00010000
00010000
00010000

TIL q
00000000
00000000
00011000
00100100
00111100
00011000
00011000
00011000

TIL r
01110111
00000000
11101110
00000000
01110111
00000000
11101110
00000000

TIL s
00000000
00001000
00000000
01000000
00000000
00000000
00000100
00000000

TIL t
00000000
00000000
00000000
00000000
00000000
00000000
11111111
00000000
>
00000000
00000000
00000000
00000000
00000000
00000000
11111111
11111111

TIL u
00000000
00001000
00001000
00101000
00100000
00100100
00000100
00000000
>
00000000
00010000
00001000
01001000
00100000
00101000
00000100
00000000

TIL v
11111111
11111111
11111111
11111111
11111111
11111111
11111111
11111111

TIL w
00000000
00111100
01111110
01111110
01111110
01111110
01111110
01111110
NAME door
COL 2

TIL x
00000000
01111110
01111110
00000000
01111110
00000000
01111110
00000000
NAME door light
COL 2

TIL y
11111110
11111110
01000100
01000100
00000000
00000000
00000000
00000000

TIL z
00000000
00001000
00000000
00000000
00010000
00000000
00000000
00001000
>
00010000
00000000
00000000
00001000
00000000
00000000
00010000
00000000

SPR A
00011000
00110100
00110100
00110100
00011000
00111100
01111100
01111100
>
00011000
00110100
01110100
00110100
00111000
01111100
11111100
00111000
POS 4 1,6

SPR a
00111100
01111110
00101100
00101110
00101110
00011110
00011110
00010100
>
00000000
00111100
01111110
00101110
00101110
00101110
00011110
00010100
DLG SPR_0
POS 0 10,4

SPR b
00111100
01111110
00110100
01110100
01110100
01111100
01111100
00100100
>
00000000
00111100
01111110
01110100
01110100
01111100
01111100
00100100
DLG SPR_1
POS 2 6,8

SPR c
00000000
00010000
01001010
00011010
01110110
01100110
00111100
00000000
>
01000000
00001010
00100000
00110100
01101110
01100110
00111110
00000000
NAME fire
DLG SPR_2
POS 2 9,4

SPR d
00000000
00000000
00010000
00001000
00000100
01111100
01011100
01111100
DLG SPR_3
POS 2 10,7

ITM 0
00000000
00000000
00011000
01111100
10111111
01111110
00111100
00000000
NAME tea
DLG ITM_0

DLG SPR_0
I'm a cat

DLG SPR_1
"""
{
  - {item "0"} == 1 ?
    {sequence
        - Thank you. Which way are you heading?
        - East, huh? I'm going west. Not sure what I expect to find.
        - It's lucky whoever lived here left firewood.
        - Stay as long as you like. I'll be moving on soon.
    }
  - else ?
    {sequence
        - I'm just passing through. Want to share some {clr3}tea {printItem "tea"}{clr3} with me?
       - I've set a {clr3}pot {printItem "tea"}{clr3} brewing by the fire. We can talk over tea.
    }
}
"""

DLG ITM_0
You gently cradle the warm pot of tea.

DLG SPR_2
"""
{sequence
  - The fire dries your cold hands - you almost forgot this feeling.
  - {shk}crackle crackle crackle{shk}
}
"""

DLG SPR_3
"""
{sequence
  - The radio is playing the hit song "1000 days & nights of rain (in my heart)."
  - It's a weather broadcast: "The forecast for tomorrow is... rain!"
  - And now a statement from 
    {wvy}The King of the Dry Lands{wvy}:
    "It's not raining & if it is it's someone else's fault!"
  - {shk}hisssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss{shk}
    
    This channel is just static.
}
"""

VAR a
42


</script>

</body>

</html>