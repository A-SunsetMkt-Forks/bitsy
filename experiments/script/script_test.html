<!DOCTYPE HTML>
<html>

<head>

<script>
var src = "{-> Hello {wvy}world{/wvy} what's\"   \"up? {seq {-> test a} {-> test b}}}"; //\n{test {what}again}"

function start() {
	console.log('hi!');
	console.log(src);

	var tokens = tokenize(src);
	console.log(tokens);

	var list = parse(tokens);
	console.log(list);

	eval(list[0]);
}

function tokenize(script) {
	// store string literals and replace them with special token
	var stringPattern = /"[\s\S]*?"/g;
	var stringLiterals = script.match(stringPattern);
	script = script.replace(stringPattern, " __string_literal__ ");

	// tokenize on whitespace
	var tokens = script
		.replace(/{/g, " { ")
		.replace(/}/g, " } ")
		.trim()
		.split(/\s+/); // split on whitespace

	// restore string literals
	var stringIndex = 0;
	for (var i = 0; i < tokens.length; i++) {
		if (tokens[i] === "__string_literal__") {
			tokens[i] = stringLiterals[stringIndex];
			stringIndex++;
		}
	}

	return tokens;
}

function parseAtom(token) {
	if (!isNaN(parseFloat(token))) {
		return {
			type: "number",
			value: parseFloat(token),
		};
	}
	else if (token[0] === "\"" && token[token.length - 1] === "\"") {
		return {
			type: "string",
			value: token.substring(1, token.length - 1),
		};
	}
	else if (token === "true") {
		return {
			type: "boolean",
			value: true,
		};
	}
	else if (token === "false") {
		return {
			type: "boolean",
			value: false,
		};
	}
	else {
		return {
			type: "symbol",
			value: token,
		};
	}
}

function parse(tokens, list) {
	if (list === undefined || list === null) {
		list = [];
	}

	while (tokens.length > 0) {
		var token = tokens.shift();
		if (token === "{") {
			list.push({
				type: "list",
				value: parse(tokens),
			});
		}
		else if (token === "}") {
			break;
		}
		else {
			list.push(parseAtom(token));
		}
	}

	return list;
}

var testBuffer = "";

var special = {
	"->": function(input) {
		for (var i = 1; i < input.length; i++) {
			if (input[i].type === "string") {
				console.log("add-text " + input[i].value);
				testBuffer += input[i].value;
			}
			else if (input[i].type != "list") {
				console.log("add-word " + input[i].value);
				testBuffer += " " + input[i].value;
			}
			else {
				eval(input[i]);
			}
		}

		console.log(" --- buffer --- \n" + testBuffer);
	},
}

function eval(expression) {
	if (expression.type === "literal") {
		return expression.value;
	}
	else if (expression.type === "symbol") {
		return expression.value; // TODO use environment
	}
	else if (expression.type === "list") {
		if (expression.value[0].value in special) {
			return special[expression.value[0].value](expression.value);
		}
		else {
			var funcName = eval(expression.value[0]);
			var args = expression.value.slice(1).map(eval);
			console.log(funcName);
			console.log(args);
			return "<<fn " + funcName + ">>";
		}
	}
}
</script>

</head>

<body onload="start();">
</body>

</html>